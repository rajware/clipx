# Package Building Guide

This guide explains how to build packages for ClipX on all platforms.

## Automated Build (Recommended)

The easiest way to build all packages is using the provided build scripts. These scripts automate:
1.  Building .NET binaries for Windows, Linux, and macOS.
2.  Creating macOS tarballs and calculating SHA256 checksums.
3.  **Generating the Homebrew formula** from the template, determining the correct hashes.
4.  Building the Windows installer (requires NSIS).
5.  Building Linux packages (requires `nfpm`).

### Windows (PowerShell)
Run the PowerShell script from the repository root:
```powershell
.\scripts\build-packages.ps1
```

### Linux / macOS (Bash)
Run the Bash script from the repository root:
```bash
./scripts/build-packages.sh
```

### Output
Artifacts will be created in the `dist/` directory:
- **Windows Installer**: `dist/clipx-setup-<version>.exe`
- **macOS Tarballs**: `dist/tarballs/clipx-macos-*.tar.gz`
- **Homebrew Formula**: `dist/homebrew/Formula/clipx.rb` (Use this for distribution)
- **Linux Packages**: `dist/packages/*.{deb,rpm,apk,pkg.tar.zst}`

---

## Prerequisites

### All Platforms
- .NET 8.0 SDK installed
- ClipX source code

### Platform-Specific Tools

**macOS (Homebrew)**:
- `tar` (usually pre-installed)
- `shasum` (usually pre-installed)

**Windows**:
- PowerShell
- NSIS 3.x (for installer)
  - Download: https://nsis.sourceforge.io/

**Linux**:
- `nfpm` (for DEB/RPM/APK packages)
  - Install: `go install github.com/goreleaser/nfpm/v2/cmd/nfpm@latest`
- `nsis` (optional, to build Windows installer on Linux)
  - Install: `sudo apt install nsis`

---

## Homebrew Formula Automation

The Homebrew formula at `packaging/homebrew/clipx.rb` is a **template**. It contains placeholders:
- `__VERSION__`
- `__SHA256_X64__`
- `__SHA256_ARM64__`

**Do not edit this file to add releases manually.** The build scripts automatically:
1.  Read the template.
2.  Calculate the SHA256 hashes of the newly built tarballs.
3.  Inject the version and hashes.
4.  Write the final, ready-to-use formula to `dist/homebrew/Formula/clipx.rb`.

To release, copy `dist/homebrew/Formula/clipx.rb` to your Homebrew tap.

---

## Manual Build Reference

If you need to build manually or understand the process, follow these steps.

### 1. Build Binaries
```bash
# Linux x64
dotnet publish src/ClipX.CLI/ClipX.CLI.csproj -c Release -r linux-x64 --self-contained -p:PublishSingleFile=true -o ./publish/linux-x64

# macOS x64
dotnet publish src/ClipX.CLI/ClipX.CLI.csproj -c Release -r osx-x64 --self-contained -p:PublishSingleFile=true -o ./publish/osx-x64

# macOS ARM64
dotnet publish src/ClipX.CLI/ClipX.CLI.csproj -c Release -r osx-arm64 --self-contained -p:PublishSingleFile=true -o ./publish/osx-arm64

# Windows x64
dotnet publish src/ClipX.CLI/ClipX.CLI.csproj -c Release -r win-x64 --self-contained -p:PublishSingleFile=true -o ./publish/win-x64
```

### 2. Create macOS Tarballs
```bash
mkdir -p dist/tarballs
# Example for x64
tar -czf dist/tarballs/clipx-macos-x64.tar.gz -C publish/osx-x64 clipx -C ../../docs/man .
```
*(Note: The scripts handle path inclusion more precisely, see `scripts/build-packages.sh` for exact `tar` command)*

### 3. Generate Homebrew Formula
Manually regex-replace placeholders in `packaging/homebrew/clipx.rb` to create the final formula.

### 4. Build Windows Installer (NSIS)
```powershell
makensis packaging/nsis/clipx.nsi
```

### 5. Build Linux Packages (nfpm)
```bash
nfpm pkg --packager deb --config packaging/nfpm/nfpm.yaml --target dist/packages/
```

---

## Distribution

### GitHub Releases
1. Create a new release on GitHub.
2. Upload all files from `dist/` (installer, tarballs, packages).

### Homebrew Tap
1. Ensure you have a `homebrew-tap` repository.
2. Copy `dist/homebrew/Formula/clipx.rb` to the `Formula/` directory in that repo.
3. Commit and push.
4. Users install via: `brew install <user>/tap/clipx`
